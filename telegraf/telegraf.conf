# ==============================================================================
#                              AGENT SEADED
# ==============================================================================
# Agent on Telegrafi "süda" - määrab, kui tihti andmeid koguda

[agent]
  interval = "10s"              # Kogu andmeid iga 10 sekundi tagant
  round_interval = true         # Ümarda ajad (10s, 20s, 30s, mitte 13s, 23s)
  metric_batch_size = 1000      # Mitu mõõtepunkti korraga saata
  metric_buffer_limit = 10000   # Buffer kui InfluxDB pole kättesaadav
  flush_interval = "10s"        # Kui tihti InfluxDB-sse saata
  hostname = ""                 # Tühi = kasuta konteineri hostname'i
  omit_hostname = false         # Lisa hostname igale mõõtepunktile

# ==============================================================================
#                              OUTPUT - kuhu andmed lähevad
# ==============================================================================

[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]     # InfluxDB aadress (konteineri nimi!)
  token = "${INFLUX_TOKEN}"           # API võti (.env failist)
  organization = "${INFLUX_ORG}"      # Organisatsioon
  bucket = "${INFLUX_BUCKET}"         # Bucket (andmete "kast")

# ==============================================================================
#                              INPUTS - kust andmed tulevad
# ==============================================================================

# ------------------------------------------------------------------------------
# SÜSTEEMI METRIC'UD - serveri ressursid
# ------------------------------------------------------------------------------

# CPU kasutus
[[inputs.cpu]]
  percpu = true                 # Iga tuuma kohta eraldi
  totalcpu = true               # + kogu CPU kokku
  collect_cpu_time = false
  report_active = false

# Mälu kasutus
[[inputs.mem]]
# Kogub: total, available, used, used_percent, free, cached, buffered

# Kettakasutus
[[inputs.disk]]
  ignore_fs = ["tmpfs", "devtmpfs", "devfs", "iso9660", "overlay", "aufs", "squashfs"]
# Kogub: total, free, used, used_percent

# Võrguliiklus
[[inputs.net]]
# Kogub: bytes_sent, bytes_recv, packets_sent, packets_recv, err_in, err_out

# Üldine süsteemi info
[[inputs.system]]
# Kogub: load1, load5, load15, uptime

# ------------------------------------------------------------------------------
# DOCKER - konteinerite info
# ------------------------------------------------------------------------------

[[inputs.docker]]
  endpoint = "unix:///var/run/docker.sock"   # Docker socket
  gather_services = false
  timeout = "5s"
  perdevice = true
  total = false
# Kogub: container_cpu, container_mem, container_net iga konteineri kohta

# ------------------------------------------------------------------------------
# HTTP MONITOORING - kas teenused töötavad?
# ------------------------------------------------------------------------------

# Flask rakenduse health check
[[inputs.http_response]]
  urls = ["http://flask-app:5000/health"]
  response_timeout = "5s"
  method = "GET"
  follow_redirects = true
  [inputs.http_response.tags]
    endpoint = "flask-health"             # Silt, et eristada teistest
# Kogub: response_time, http_response_code, result_code

# Chuck Norris API monitooring
[[inputs.http_response]]
  urls = ["https://api.chucknorris.io/jokes/random"]
  response_timeout = "10s"
  method = "GET"
  follow_redirects = true
  [inputs.http_response.tags]
    endpoint = "chuck-norris-api"
# Kogub: response_time, http_response_code - kas väline API töötab?

# ------------------------------------------------------------------------------
# LOGIDE JÄLGIMINE - vigade tuvastamine
# ------------------------------------------------------------------------------

[[inputs.tail]]
  files = ["/app/logs/app.log"]           # Flask'i logifail
  from_beginning = false                   # Ainult uued read
  data_format = "grok"                     # Parsi struktureeritud andmeid
  grok_patterns = ["%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{GREEDYDATA:message}"]
  name_override = "app_logs"               # Measurement nimi InfluxDB-s
# Kogub: iga logirida koos tasemega (INFO, WARNING, ERROR)
